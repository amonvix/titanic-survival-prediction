name: Deploy to AWS ECS (manual)

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (e.g., a Git SHA from CI)'
        required: true
      environment:
        description: 'Environment name (staging|production)'
        required: true
        default: 'staging'

permissions:
  contents: read
  id-token: write      # OIDC
  packages: read

env:
  IMAGE: ghcr.io/${{ github.repository }}/titanic

jobs:
  deploy-ecs:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    concurrency:
      group: deploy-${{ github.event.inputs.environment }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install jq (ensure available)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Login to GHCR (for private image pulls if needed)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Describe current task definition
        env:
          FAMILY: ${{ secrets.ECS_TASK_FAMILY }}
        run: |
          aws ecs describe-task-definition --task-definition "$FAMILY" > td.json

      - name: Create new task definition revision with new image
        env:
          FAMILY: ${{ secrets.ECS_TASK_FAMILY }}
          NEW_IMAGE: ${{ env.IMAGE }}:${{ github.event.inputs.image_tag }}
          CONTAINER_NAME: ${{ secrets.ECS_CONTAINER_NAME }}
        run: |
          cat td.json \
          | jq '.taskDefinition
                | .containerDefinitions
                |= (map(if .name == env.CONTAINER_NAME then .image = env.NEW_IMAGE else . end))
                | del(.taskDefinitionArn,.revision,.status,.requiresAttributes,.compatibilities,.registeredAt,.registeredBy,.deregisteredAt)' \
          > new-td.json

          NEW_TD_ARN=$(aws ecs register-task-definition --cli-input-json file://new-td.json | jq -r '.taskDefinition.taskDefinitionArn')
